# --- Argo CD Project Configuration ---
apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: mt-be24c298  # Project Name
  namespace: argocd  # Namespace where Argo CD is installed
spec:
  description: Project to manage northwind workflows
  sourceRepos:
    - '*'  # Allow all repositories
  destinations:
    - namespace: mt-be24c298  # Namespace for the workflows
      server: https://kubernetes.default.svc  # Kubernetes API server URL
  clusterResourceWhitelist:
    - group: argoproj.io
      kind: Workflow  # Allow Workflow resources
  namespaceResourceWhitelist:
    - group: ""  # Allow core resources (e.g., Pods, ConfigMaps)
      kind: "*"

---

# --- Role for Managing Workflows ---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: workflow-admin  # Role Name
rules:
  - apiGroups: ["argoproj.io"]
    resources: ["workflows"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

---

# --- Bind Role to Service Account ---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: workflow-admin-binding  # Role Binding Name
subjects:
  - kind: ServiceAccount
    name: default  # Default Service Account (can be customized)
    namespace: mt-be24c298  # Namespace where the app runs
roleRef:
  kind: ClusterRole
  name: workflow-admin
  apiGroup: rbac.authorization.k8s.io

---

# --- Workflow Template ---
apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  name: fetch-northwind-supplier  # Workflow Name
  namespace: mt-be24c298  # Replace with your namespace
spec:
  entrypoint: fetch-supplier-data
  templates:
    - name: fetch-supplier-data
      container:
        image: curlimages/curl:latest
        command: [sh, -c]
        args:
          - "curl -o /tmp/suppliers.json https://services.odata.org/V2/Northwind/Northwind.svc/Suppliers?$format=json"
        volumeMounts:
          - name: output
            mountPath: /tmp
      outputs:
        artifacts:
          - name: supplier-data
            path: /tmp/suppliers.json
  volumes:
    - name: output
      emptyDir: {}
